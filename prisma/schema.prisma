generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model activites {
  id  Int    @id @default(autoincrement())
  nom String @unique @db.VarChar(50)
}


model cote_piece {
  id            Int     @id @default(autoincrement())
  piece_id      Int?
  nom_cote      String? @db.VarChar(255)
  tolerance_min Int?
  tolerance_max Int?

  // ðŸ‘‡ Relation inverse vers piece
  piece piece? @relation(fields: [piece_id], references: [id])

  @@index([piece_id], map: "piece_id")
}

model debut_etching {
  id            Int       @id @default(autoincrement())
  id_lot        Int
  num_lot_wafer String?   @db.VarChar(50)
  nb_pieces     Int?
  operateur     String?   @db.VarChar(50)
  nb_passage    Int?
  date_debut    String
  heure_debut   String
  temps_reel    Int?
  koh           String?   @db.VarChar(50)
  bain          String?   @db.VarChar(50)
  position      String?
  commentaire   String?   @db.Text
  created_at    DateTime? @default(now()) @db.Timestamp(0)
}

model debut_tomo {
  id_lot      Int      @id
  nb_pieces   Int
  etage       Int
  date        DateTime @db.Date
  heure_debut DateTime @db.Time(0)
  operateur   String   @db.VarChar(50)
  num_machine String   @db.VarChar(50)
  version     String   @db.VarChar(25)
  separation  String   @db.VarChar(25)
  commentaire String?  @db.Text
}

model denomination_options {
  id         Int       @id @default(autoincrement())
  name       String    @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(0)
}


model fin_etching {
  id_lot            Int     @id @default(autoincrement())
  num_lot_wafer     String  @db.VarChar(50)
  nb_passage        Int
  date_fin          String
  heure_fin         String
  nb_piece_conforme Int
  operateur         String  @db.VarChar(100)
  commentaire       String? @db.Text
}

model fin_impression {
  id_lot        Int       @id
  num_lot_wafer String?   @db.VarChar(50)
  nb_lancees    Int?
  nb_imprimees  Int?
  operateur     String?   @db.VarChar(100)
  date_fin      DateTime? @db.Date
  commentaires  String?   @db.Text
}

model fin_tomo {
  id_lot    Int      @id
  quantite  Int
  date      DateTime @db.Date
  heure     DateTime @db.Time(0)
  operateur String   @db.VarChar(50)
}

model imprimantes {
  id  Int    @id @default(autoincrement())
  nom String @unique @db.VarChar(100)
}

model lot_status {
  id_lot           Int       @id
  nb_pieces        Int?
  current_step     String?   @db.VarChar(100)
  updated_at       DateTime? @default(now()) @updatedAt @db.DateTime(0)
  activity         String?   @db.VarChar(25)
  type_piece       String    @db.VarChar(100)
  revision         String    @db.VarChar(50)
  disponible_finis Boolean   @default(false)

  @@index([type_piece, current_step, disponible_finis], name: "idx_lot_status_type_step_dispo")
}

model mesure_cote_piece {
  id              Int    @id @default(autoincrement())
  id_piece_locale String @db.VarChar(100)
  id_cote_piece   Int
  valeur          Int
  id_lot          Int
  nb_passage      Int

  @@index([id_cote_piece], map: "id_cote_piece")
  @@index([id_lot, nb_passage], map: "fk_mesure_prise")
}

model nc_pieces {
  id                 Int       @id @default(autoincrement())
  id_lot             String    @db.VarChar(50)
  id_piece           String    @db.VarChar(50)
  operateur          String?   @db.VarChar(100)
  date               DateTime? @db.Date
  denomination       String?   @db.VarChar(100)
  produit            String?   @db.VarChar(100)
  type_de_production String?   @db.VarChar(100)
  type               String?   @db.VarChar(50)
  description        String?   @db.Text
  decision           String?   @db.Text
  cause_racine       String?   @db.Text
  statut             String?   @default("Non traitÃ©") @db.VarChar(50)
  created_at         DateTime? @default(now()) @db.Timestamp(0)
  updated_at         DateTime? @default(now()) @updatedAt @db.Timestamp(0)
  justification      String?   @db.Text
  lien               String?   @db.Text
}

model nouvelle_impression {
  id              Int       @id @default(autoincrement())
  activity        String?   @db.VarChar(50)
  type_pieces     String?   @db.VarChar(50)
  version_piece   String?   @db.VarChar(10)
  num_lot_wafer   String?   @db.VarChar(255)
  nb_pieces       Int?
  imprimante      String?   @db.VarChar(50)
  date_impression DateTime? @db.Date
  operateur       String?   @db.VarChar(50)
  commentaire     String?   @db.Text
  created_at      DateTime? @default(now()) @db.Timestamp(0)
}

model piece {
  id       Int          @id @default(autoincrement())
  nom      String       @unique @db.VarChar(100)
  nb_cotes Int
  cotes    cote_piece[]
}

model prise_de_cotes {
  id_lot        Int
  nb_passage    Int
  type_piece    String?   @db.VarChar(100)
  nombre_pieces Int?
  date          DateTime? @db.Date

  @@id([id_lot, nb_passage])
}

model users {
  id          Int       @id @default(autoincrement())
  nom         String    @db.VarChar(100)
  prenom      String    @db.VarChar(100)
  email       String    @unique @db.VarChar(100)
  password    String    @db.VarChar(100)
  is_verified Boolean   @default(false)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
}

model version_piece {
  version   String  @id @db.VarChar(50)
  nom_piece String? @db.VarChar(255)
}

model CalendarEvent {
  id        Int       @id @default(autoincrement())
  title     String
  startDate DateTime
  endDate   DateTime?
  color     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("calendarevent")
}

// update gestion pieces on ajoutant produit semi finis achetÃ©s et produit finis
model SemiFiniAchete {
  id        Int      @id @default(autoincrement())
  nom       String   @unique
  quantite  Int      @default(0)
  createdAt DateTime @default(now())

  @@map("semifiniachete")
}

//produit finis et ses references
model ProduitFini {
  id         Int                    @id @default(autoincrement())
  nom        String
  references ProduitFiniReference[]
  createdAt  DateTime               @default(now())

  @@map("produitfini")
}

model ProduitFiniReference {
  id            Int @id @default(autoincrement())
  produitFiniId Int

  // 'semi-finis' | 'semi-finis-achetes'
  type String

  nom String

  quantite        Int
  tracerNumeroLot Boolean @default(false)

  produitFini ProduitFini @relation(fields: [produitFiniId], references: [id])

  @@index([produitFiniId])
  @@map("produitfinireference")
}

model SemiFiniPreAssemblage {
  id         Int                              @id @default(autoincrement())
  nom        String
  references SemiFiniPreAssemblageReference[]
  createdAt  DateTime                         @default(now())

  @@map("semifinipreassemblage")
}

model SemiFiniPreAssemblageReference {
  id                      Int @id @default(autoincrement())
  semiFiniPreAssemblageId Int

  // 'semi-finis' | 'semi-finis-achetes'
  type String

  nom String

  quantite        Int
  tracerNumeroLot Boolean @default(false)

  semiFiniPreAssemblage SemiFiniPreAssemblage @relation(fields: [semiFiniPreAssemblageId], references: [id], onDelete: Cascade)

  @@index([semiFiniPreAssemblageId])
  @@map("semifinipreassemblagereference")
}

model debut_preassemblage {
  id_debutpreassemblage String @id @db.VarChar(50)

  activite     String @db.VarChar(50)
  produit_fini String @db.VarChar(50)

  lot_corps Int
  date      DateTime @db.Date

  operateur String @db.VarChar(20)

  piece_disponible  Int @default(0)
  quantite_utilisee Int @default(0)

  commentaire String? @db.Text

  created_at DateTime @default(now())

  references debut_preassemblage_reference[]
  pieces     debut_preassemblage_piece[]
  fin        fin_preassemblage?

  @@index([produit_fini])
  @@index([lot_corps])
  @@index([date])
}

model debut_preassemblage_reference {
  id                    Int @id @default(autoincrement())
  id_debutpreassemblage String @db.VarChar(50)

  reference_nom String @db.VarChar(150)
  lot_valeur    String @db.VarChar(100)

  created_at DateTime @default(now())

  debut_preassemblage debut_preassemblage @relation(fields: [id_debutpreassemblage], references: [id_debutpreassemblage])

  @@unique([id_debutpreassemblage, reference_nom])
  @@index([id_debutpreassemblage])
}

model debut_preassemblage_piece {
  id                    Int @id @default(autoincrement())
  id_debutpreassemblage String @db.VarChar(50)

  piece_code String @db.VarChar(60)

  created_at DateTime @default(now())

  debut_preassemblage debut_preassemblage @relation(fields: [id_debutpreassemblage], references: [id_debutpreassemblage])

  @@index([id_debutpreassemblage])
}


//tables fin de prÃ©-asse
model fin_preassemblage {
  id_finpreassemblage String   @id @map("id_debutpreassemblage") @db.VarChar(50)
  activite     String @db.VarChar(50)
  produit_fini String @db.VarChar(50)
  date                  DateTime @db.Date
  operateur             String   @db.VarChar(20)
  commentaire           String?  @db.Text

  created_at            DateTime @default(now())

  debut debut_preassemblage @relation(fields: [id_finpreassemblage], references: [id_debutpreassemblage], onDelete: Cascade )

  pieces fin_preassemblage_piece[]
}

model fin_preassemblage_piece {
  id                    Int      @id @default(autoincrement())

  id_finpreassemblage String   @map("id_debutpreassemblage") @db.VarChar(50)
  piece_code            String   @db.VarChar(60)

  qc_ok                 Boolean  @default(false)

  created_at            DateTime @default(now())

  fin fin_preassemblage @relation(fields: [id_finpreassemblage], references: [id_finpreassemblage], onDelete: Cascade)

  @@unique([id_finpreassemblage, piece_code])
  @@index([id_finpreassemblage])
}

// tables debut assemblage (structure similaire au debut_preassemblage)
model debut_assemblage {
  id_debutassemblage String @id @db.VarChar(50)

  activite     String @db.VarChar(50)
  produit_fini String @db.VarChar(50)
  lot_asm      String @db.VarChar(50)

  date      DateTime @db.Date
  operateur String   @db.VarChar(20)

  piece_disponible  Int @default(0)
  quantite_utilisee Int @default(0)

  commentaire String? @db.Text

  created_at DateTime @default(now())

  references debut_assemblage_reference[]
  pieces     debut_assemblage_piece[]
  fin        fin_assemblage?

  @@index([produit_fini])
  @@index([lot_asm])
  @@index([date])
}

model debut_assemblage_reference {
  id                 Int @id @default(autoincrement())
  id_debutassemblage String @db.VarChar(50)

  reference_nom String @db.VarChar(150)
  lot_valeur    String @db.VarChar(100)

  created_at DateTime @default(now())

  debut_assemblage debut_assemblage @relation(fields: [id_debutassemblage], references: [id_debutassemblage])

  @@unique([id_debutassemblage, reference_nom])
  @@index([id_debutassemblage])
}

model debut_assemblage_piece {
  id                 Int @id @default(autoincrement())
  id_debutassemblage String @db.VarChar(50)

  piece_code String @db.VarChar(60)

  created_at DateTime @default(now())

  debut_assemblage debut_assemblage @relation(fields: [id_debutassemblage], references: [id_debutassemblage])

  @@index([id_debutassemblage])
}

model fin_assemblage {
  id_finassemblage   String   @id @db.VarChar(50)
  date        DateTime @db.Date
  operateur   String   @db.VarChar(20)
  commentaire String?  @db.Text

  created_at DateTime @default(now())

  debut  debut_assemblage @relation(fields: [id_finassemblage], references: [id_debutassemblage], onDelete: Cascade)
  pieces fin_assemblage_piece[]
}

model fin_assemblage_piece {
  id                 Int      @id @default(autoincrement())
  id_finassemblage   String   @db.VarChar(50)
  piece_code         String   @db.VarChar(60)

  qc_ok               Boolean  @default(false)

  created_at DateTime @default(now())

  fin fin_assemblage @relation(fields: [id_finassemblage], references: [id_finassemblage], onDelete: Cascade)

  @@unique([id_finassemblage, piece_code])
  @@index([id_finassemblage])
}

// ================================
// Production finis - Tomographie
// ================================
model debuttomo_finis {
  id_debuttomo String   @id @db.VarChar(50)
  activite     String   @db.VarChar(50)
  produit_fini String   @db.VarChar(50)
  nb_puces_disponibles Int
  nb_puces_tomo Int
  etage        Int
  date         DateTime @db.Date
  heure_debut  DateTime @db.Time(0)
  operateur    String   @db.VarChar(50)
  num_machine  String   @db.VarChar(50)
  version      String   @db.VarChar(25)
  separation   String   @db.VarChar(25)
  commentaire  String?  @db.Text

  @@index([id_debuttomo])
}

model fin_tomo_finis {
  id_debuttomo String   @id @db.VarChar(50)
  activite     String   @db.VarChar(50)
  produit_fini String   @db.VarChar(50)
  nb_puces_tomo Int
  date         DateTime @db.Date
  heure        DateTime @db.Time(0)
  operateur    String   @db.VarChar(50)
  commentaire  String?  @db.Text
}


